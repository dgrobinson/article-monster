name: Sync Submodule Updates

on:
  schedule:
    # Check for updates every 24 hours at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write      # allow pushing submodule changes
  issues: write        # allow creating failure issues

jobs:
  check-submodule:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.sync.outputs.updated }}
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update submodule to latest
      run: |
        echo "ðŸ”„ Starting submodule update process..."
        echo "Current submodule commit: $(git rev-parse HEAD:site-configs)"

        git submodule update --remote site-configs

        echo "New submodule commit: $(git rev-parse HEAD:site-configs)"
        echo "Submodule status:"
        git submodule status site-configs

    - name: Check for changes and commit
      id: sync
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

        echo "ðŸ” Checking for submodule changes..."
        git status --porcelain

        if ! git diff --quiet site-configs; then
          echo "âœ… Submodule changes detected!"
          echo "Changes:"
          git diff --name-status site-configs

          git add site-configs

          # Get the latest commit message from the submodule for context
          SUBMODULE_COMMIT=$(cd site-configs && git log -1 --pretty=format:"%h - %s")
          echo "Latest submodule commit: $SUBMODULE_COMMIT"

          git commit -m "Update site-configs submodule to latest version

Auto-sync: $SUBMODULE_COMMIT
Triggered: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          echo "ðŸ“¤ Pushing changes..."
          git push
          echo "âœ… Submodule updated and pushed successfully!"

          # Set output for potential notifications
          echo "updated=true" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸ No submodule changes detected - site-configs is up to date"
          echo "updated=false" >> $GITHUB_OUTPUT
        fi

    - name: Notify maintainers on update
      if: steps.sync.outputs.updated == 'true'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"site-configs submodule updated in $GITHUB_REPOSITORY\"}" "$SLACK_WEBHOOK_URL"
        fi

    - name: Create issue on failure
      uses: actions/github-script@v7
      if: failure()
      with:
        script: |
          const title = `Submodule sync failed - ${new Date().toISOString().split('T')[0]}`;
          const body = `## Submodule Sync Failure

          The automated submodule sync workflow failed.

          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Time:** ${{ github.event.head_commit.timestamp || github.run_started_at }}
          **Branch:** ${{ github.ref }}

          Please check the logs and resolve the issue.

          This issue was automatically created by the submodule sync workflow.`;

          // Check if similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['submodule-sync-failure']
          });

          if (issues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['submodule-sync-failure', 'automated']
            });
          }

    - name: Notify maintainers on failure
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"Submodule sync failed for $GITHUB_REPOSITORY. See run $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\"}" "$SLACK_WEBHOOK_URL"
        fi

